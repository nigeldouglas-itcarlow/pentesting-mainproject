<?php

// Include the database connection file
include 'dbh.inc.php';

// Start the session
session_start();

// Check if the CSRF token is provided and is correct
if (!isset($_POST['csrf-token']) || $_POST['csrf-token'] !== "5f165e25a63d2081a8ed0e90093960587ea2e23b00359b577268b251d62d33e9") {
    // If CSRF token is missing or incorrect, redirect to an error page
    header("Location: ../csrf_error.php");
    exit();
}

// Get parameters from the POST request
$oldpass = $_POST['old'];
$newConfirm = $_POST['new_confirm'];
$newpass = $_POST['new'];

// Check if old password or new password is empty
if (empty($oldpass) || empty($newpass)) {
    // If old password or new password is empty, redirect to an error page
    header("Location: ../reset_error.php?error=I win");
    exit();
}

// Get user ID from the session
$uid = $_SESSION['u_uid'];

// Check if the user exists in the 'sapusers' table
$checkOld = "SELECT * FROM `sapusers` WHERE `user_uid` = ?";
$stmt = $conn->prepare($checkOld);
$stmt->bind_param("s", $uid);
$stmt->execute();
$result = $stmt->get_result();

if ($result->num_rows > 0) {
    // If user exists

    $row = mysqli_fetch_assoc($result); // Fetch user data

    // Check if the old password matches the stored password
    if (strcmp($oldpass, $row['user_pwd']) !== 0) {
        // If old password doesn't match, redirect to an error page
        header("Location: ../reset_error.php?error=4");
        exit();
    } else {
        // If the new password and confirmation match, update the password
        if ($newConfirm == $newpass) {

            $changePass = "UPDATE `sapusers` SET `user_pwd` = ? WHERE `user_uid` = ?";
            $stmt = $conn->prepare($changePass);
            $stmt->bind_param("ss", $newpass, $uid);

            // Execute the statement
            if(!$stmt->execute()) {
                // If execution fails, redirect to an error page
                header("Location: ../reset_error.php?error=execution");
                exit();
            }

            // Redirect to logout.inc.php after successful password change
            header("Location: ./logout.inc.php");
            exit();
        } else {
            // If new password and confirmation don't match, redirect to an error page
            header("Location: ../reset_error.php?error=5");
            exit();
        }
    }
} else {
    // If user doesn't exist, redirect to an error page
    header("Location: ../reset_error.php?error=6");
    exit();
}
