<?php

// Check if the form is submitted
if (isset($_POST['createDatabase'])) {
    try {
        // Database connection parameters
        $host = "localhost";
        $username = "TEST";
        $password = "";

        // Connect to MySQL server
        $conn = new PDO("mysql:host=$host", $username, $password);

        // Set the PDO error mode to exception
        $conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

        // Get existing databases
        $existingDatabases = $conn->query("SHOW DATABASES")->fetchAll(PDO::FETCH_COLUMN);

        if (!in_array('secureappdev', $existingDatabases)) {
            // Create a new database
            $sql = "CREATE DATABASE secureappdev";
            $conn->exec($sql);
            echo "Database 'secureappdev' created successfully<br>";

            // Switch to the new database
            $sql = "USE secureappdev";
            $conn->exec($sql);

            // Create users table
            $makeUsers = "CREATE TABLE `sapusers` (
                `user_id` int(11) NOT NULL AUTO_INCREMENT,
                `user_uid` varchar(256) NOT NULL,
                `user_pwd` varchar(256) NOT NULL,
                `user_admin` int(2) NOT NULL DEFAULT 0,
                PRIMARY KEY (`user_id`)
            )";
            $conn->exec($makeUsers);
            echo "Table 'sapusers' created successfully<br>";

            // Insert admin user
            $makeAdmin = "INSERT INTO `sapusers` (`user_uid`, `user_pwd`, `user_admin`) VALUES ('admin', 'AdminPass1!', '1')";
            $conn->exec($makeAdmin);
            echo "Admin Added (Username = admin, Password = AdminPass1!)<br>";

            // Insert another user
            $makeUser = "INSERT INTO `sapusers` (`user_uid`, `user_pwd`, `user_admin`) VALUES ('nigeldouglas', 'Password1!', '1')";
            $conn->exec($makeUser);
            echo "User Added (Username = nigeldouglas, Password = Password1!)<br>";

            // Create table to track failed login attempts
            $makeCounter = "CREATE TABLE `failedLogins` (
                `event_id` int(11) NOT NULL AUTO_INCREMENT,
                `ip` varchar(128) NOT NULL,
                `timeStamp` datetime NOT NULL,
                `failedLoginCount` int(11) NOT NULL,
                `lockOutCount` int(11) NOT NULL,
                PRIMARY KEY (`event_id`)
            )";
            $conn->exec($makeCounter);

            // Create table to track login events
            $loginEvents = "CREATE TABLE `loginEvents` (
                `event_id` int(11) NOT NULL AUTO_INCREMENT,
                `ip` varchar(128) NOT NULL,
                `timeStamp` datetime NOT NULL,
                `user_id` varchar(50) NOT NULL,
                `outcome` varchar(7) NOT NULL,
                PRIMARY KEY (`event_id`)
            )";
            $conn->exec($loginEvents);

            echo "Tables created successfully<br>";
        }

    } catch (PDOException $e) {
        echo "Error: " . $e->getMessage();
    }

    $conn = null; // Close the database connection
}

?>
